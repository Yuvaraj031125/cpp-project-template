name: CI Workflow
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ cppcheck lcov ninja-build
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="--coverage" \
            -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
            -DCMAKE_RUNTIME_OUTPUT_DIRECTORY="${GITHUB_WORKSPACE}/build/bin" \
            -DCMAKE_LIBRARY_OUTPUT_DIRECTORY="${GITHUB_WORKSPACE}/build/lib" \
            -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY="${GITHUB_WORKSPACE}/build/lib"
      - name: Build
        run: cmake --build build -- -j$(nproc)
      - name: Test
        run: ctest --test-dir build --output-on-failure
      - name: Install (optional)
        run: cmake --build build --target install || echo "No install target"
      - name: Discover artifact
        id: artifact
        run: |
          set -eux
          artifact=""
          if [ -d build/bin ]; then
            artifact=$(find build/bin -type f -perm -111 | head -n 1 || true)
          fi
          if [ -z "${artifact}" ]; then
            artifact=$(find build -type f \( -perm -111 -o -name "*.jar" -o -name "*.so" -o -name "*.dylib" -o -name "*.dll" -o -name "*.a" -o -name "*.whl" -o -name "*.tar.gz" -o -name "*.zip" \) | head -n 1 || true)
          fi
          echo "ARTIFACT_PATH=${artifact}" >> $GITHUB_ENV
      - name: Package artifact
        if: env.ARTIFACT_PATH != ''
        run: |
          set -eux
          mkdir -p out
          base="$(basename "${ARTIFACT_PATH}")"
          dir="$(dirname "${ARTIFACT_PATH}")"
          tar -cvf "out/${base}.tar" -C "${dir}" "${base}"
          echo "TAR_PATH=out/${base}.tar" >> $GITHUB_ENV
      - name: Upload artifact
        if: env.TAR_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: cpp-project-template
          path: ${{ env.TAR_PATH }}
